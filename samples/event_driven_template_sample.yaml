################################################################################
# LIGHTING DIRECTIVE – EXAMPLE (TEMPLATE SENSOR)
#
# ORGANIZATION: This example uses a `template:` block. Whether you need it depends
# on your include context:
#   * If configuration.yaml has `template: !include templates.yaml`, then templates.yaml
#     should NOT have `template:` (it should be the list items directly).
#   * If you include a full file/package that defines top-level keys, it MUST include
#     `template:` as a top-level key.
# See your configuration includes to determine which applies.
#
# PURPOSE:
#   Emits a simple directive ("on" vs "hold") based on an indoor illuminance
#   reading, with a non-critical post-restart stagger gate.
#
# STATES:
#   - on:   Indoor lux below threshold (room is considered dark)
#   - hold: Indoor lux at/above threshold (no action needed)
#
# INPUTS (replace with your real entities):
#   - sensor.example_indoor_lux
#   - sensor.example_outdoor_irradiance
#   - timer.ha_startup_delay
#
# DESIGN NOTES:
#   - Single-read variables: compute lux once, derive state/reason from it.
#   - Restart-friendly: re-evaluate once after startup delay clears (staggered).
#   - Explainability: keep the state minimal; put "why" in a single `reason` attr.
#   - Debug-ready: optional debug_* attrs are present but commented out.
#
# APPLIES: /patterns/lighting_directives.md
#
# CHANGELOG:
# - 20260102-1200: Canonical generic example. YAML syntax current as of 2026.1.x.
# - 20251022-1430: Added HA restart stagger gate on trigger.
# - 20251019-0900: Initial example.
################################################################################
template:
  - triggers:
      # Indoor lux changed
      - trigger: state
        entity_id: sensor.example_indoor_lux
      # Outdoor irradiance changed (trigger failsafe: indoor lux sensor sometimes lags
      # when clouds move overhead; irradiance trigger ensures sensor re-evaluates even
      # if indoor lux hasn't changed enough to fire its own trigger)
      - trigger: state
        entity_id: sensor.example_outdoor_irradiance
      # HA startup gate (non-critical, 45–75s stagger)
      - trigger: state
        entity_id: timer.ha_startup_delay
        from: active
        to: idle
        for:
          seconds: "{{ range(45, 75) | random }}"
    sensor:
      - name: "Lighting Directive – Example"
        unique_id: lighting_directive_example
        # deps: sensor.example_indoor_lux, sensor.example_outdoor_irradiance, timer.ha_startup_delay
        variables:
          lux: "{{ states('sensor.example_indoor_lux') | float(0) }}"
          threshold_lux: 40
          state_v: >-
            {% if lux < threshold_lux %}
              on
            {% else %}
              hold
            {% endif %}
          reason_v: >-
            {% if state_v == 'on' %}
              Indoor lux below threshold
            {% else %}
              Indoor lux at/above threshold
            {% endif %}
        state: "{{ state_v }}"
        attributes:
          reason: "{{ reason_v }}"
          # debug_lux: "{{ lux }}"
          # debug_threshold_lux: "{{ threshold_lux }}"
