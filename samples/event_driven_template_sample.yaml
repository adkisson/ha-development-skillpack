################################################################################
# EXAMPLE AREA LIGHTING TARGETS – TEMPLATE SENSOR (CANONICAL)
#
# ORGANIZATION: This example uses a `template:` block. Whether you need it depends
# on your include context:
#   * If configuration.yaml has `template: !include templates.yaml`, then templates.yaml
#     should NOT have `template:` (it should be the list items directly).
#   * If you include a full file/package that defines top-level keys, it MUST include
#     `template:` as a top-level key.
# See your configuration includes to determine which applies.
#
# PURPOSE:
#   Computes an area lighting "targets" output:
#     - State: "on"/"off"
#     - Attributes: `has_targets`, `items_json`, `unavailable_entities`
#
# CONTRACT:
#   - `items_json` is the primary output for downstream apply scripts.
#   - Only three sample per-light shapes are demonstrated:
#       1) brightness only
#       2) color_temp_kelvin only
#       3) rgb_color derived from kelvin via a lookup
#
# CHANGELOG:
# - 20260115-1145: Simplified canonical sample (3 item shapes). YAML syntax current as of 2026.1.x.
# - 20260102-1200: Canonicalized header + organization guidance + JSON items contract.
# - 20251019-0900: Initial example.
################################################################################

template:
  - triggers:
      - trigger: state
        entity_id:
          - sensor.example_area_ambient_lux
          - input_boolean.example_area_lights_disable

      - trigger: time_pattern
        minutes: "/5"

      # Post-restart recovery (non-critical, staggered)
      - trigger: state
        entity_id: timer.ha_startup_delay
        from: active
        to: idle
        for:
          seconds: "{{ range(45, 75) | random }}"

    variables:
      # === Inputs (single-read) ===
      manual_block: "{{ is_state('input_boolean.example_area_lights_disable', 'on') }}"
      lux_available: "{{ has_value('sensor.example_area_ambient_lux') }}"
      lux: "{{ states('sensor.example_area_ambient_lux') | float(0) }}"

      # === Simple plan (single brightness variable for the whole area) ===
      threshold_lux: 40
      brightness_pct: "{{ 25 if (lux_available and lux < threshold_lux) else 0 }}"

      # === Color plan (kelvin -> rgb lookup) ===
      kelvin: 2082
      kelvin_rgb_table: "{{ {2000:[255,180,80], 2100:[255,185,90], 2200:[255,190,100]} }}"
      rgb_from_kelvin: >-
        {% set rounded = (kelvin | int // 100) * 100 %}
        {{ kelvin_rgb_table.get(rounded, [255, 216, 255]) }}

      # === Example target entities (replace with your real lights) ===
      light_brightness_only: light.example_area_main
      light_kelvin_only: light.example_area_bedside
      light_rgb_from_kelvin: light.example_area_led_strip

      # === Unavailable tracking ===
      unavailable_entities_list: >-
        {% set ns = namespace(u=[]) %}
        {% for eid in [light_brightness_only, light_kelvin_only, light_rgb_from_kelvin] %}
          {% if not has_value(eid) %}
            {% set ns.u = ns.u + [eid] %}
          {% endif %}
        {% endfor %}
        {{ ns.u }}

      # === Global on/off + has_targets ===
      lighting_allowed: "{{ (not manual_block) and (brightness_pct | int(0) > 0) }}"
      has_targets: "{{ lighting_allowed }}"

    sensor:
      - name: "Example Area – Lighting Targets"
        unique_id: example_area_lighting_targets
        icon: mdi:lightbulb-group
        state: "{{ 'on' if has_targets else 'off' }}"

        attributes:
          has_targets: "{{ has_targets }}"

          items_json: >-
            {% if not has_targets %}
              {{ [] | to_json }}
            {% else %}
              {% set ns = namespace(l=[]) %}

              {% if light_brightness_only not in unavailable_entities_list %}
                {% set ns.l = ns.l + [ {'light': light_brightness_only, 'brightness_pct': (brightness_pct | int(0))} ] %}
              {% endif %}

              {% if light_kelvin_only not in unavailable_entities_list %}
                {% set ns.l = ns.l + [ {'light': light_kelvin_only, 'brightness_pct': (brightness_pct | int(0)), 'color_temp_kelvin': (kelvin | int)} ] %}
              {% endif %}

              {% if light_rgb_from_kelvin not in unavailable_entities_list %}
                {% set ns.l = ns.l + [ {'light': light_rgb_from_kelvin, 'brightness_pct': (brightness_pct | int(0)), 'rgb_color': rgb_from_kelvin} ] %}
              {% endif %}

              {{ ns.l | to_json }}
            {% endif %}

          unavailable_entities: "{{ unavailable_entities_list }}"

          # sample_brightness_pct: "{{ brightness_pct | int }}"
          # sample_kelvin: "{{ kelvin | int }}"
          # sample_rgb: "{{ rgb_from_kelvin }}"
