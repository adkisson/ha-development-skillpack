alias: Script â€“ Idempotent Light Turn-On Wrapper
description: >
  Centralized light action executor with an idempotency guard to minimize chatter.
  Queued mode reduces concurrent writes to the same entity.
  Guard compares desired vs actual state/brightness and skips if already correct.

  CHANGELOG:
  - 2026-01-02: Canonicalized. Verified on HA 2025.12+.

mode: queued
max: 10

fields:
  target:
    description: Target light entity (required). Accept entity ID string or {entity_id: "..."} mapping.
    example: light.kitchen
    required: true
  brightness_pct:
    description: Desired brightness percent (0-100). Defaults to 100.
    example: 80
    required: false
  transition_s:
    description: Transition seconds (0-10). Defaults to 1.5.
    example: 1.5
    required: false

sequence:
  - alias: Normalize target to entity ID
    variables:
      target_eid: >
        {% if target is mapping and target.entity_id is defined %}
          {{ target.entity_id }}
        {% elif target is string %}
          {{ target }}
        {% else %}
          invalid
        {% endif %}

  - alias: Validate inputs (must be a real entity with a usable state)
    condition: template
    value_template: >
      {{ target_eid != 'invalid' and has_value(target_eid) }}

  - alias: Resolve desired vs actual
    variables:
      brightness_pct_safe: >-
        {{ (brightness_pct | default(100) | float(100)) | max(0) | min(100) | int(0) }}
      transition_safe: >-
        {{ (transition_s | default(1.5) | float(1.5)) | max(0) | min(10) }}
      desired_brightness: >-
        {{ (brightness_pct_safe * 255 / 100) | round(0) | int(0) }}
      actual_state: "{{ states(target_eid) }}"
      actual_brightness_attr: "{{ state_attr(target_eid, 'brightness') }}"
      actual_brightness: "{{ actual_brightness_attr | int(0) }}"
      supports_brightness: "{{ actual_brightness_attr is not none }}"
      tol: 3

  - alias: Idempotency guard (skip if already correct)
    condition: template
    value_template: >
      {{ actual_state != 'on'
         or (supports_brightness and ((actual_brightness - desired_brightness) | abs > tol)) }}

  - alias: Apply action
    action: light.turn_on
    target:
      entity_id: "{{ target_eid }}"
    data:
      brightness_pct: "{{ brightness_pct_safe }}"
      transition: "{{ transition_safe }}"
    continue_on_error: true
